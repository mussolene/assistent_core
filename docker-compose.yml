services:
  redis:
    image: redis:7-alpine
    container_name: assistant-redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - assistant
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M

  dashboard:
    build:
      context: .
      dockerfile: assistant/docker/Dockerfile.dashboard
    ports:
      - "8080:8080"
    environment:
      REDIS_URL: redis://redis:6379/0
      WORKSPACE_DIR: /workspace
      GIT_WORKSPACE_DIR: ${GIT_WORKSPACE_DIR:-/workspace}
    volumes:
      - workspace_sandbox:/workspace
      - git_repos:/git_repos
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - assistant
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 128M
    user: "1000:1000"

  assistant-core:
    build:
      context: .
      dockerfile: assistant/docker/Dockerfile.core
    environment:
      REDIS_URL: redis://redis:6379/0
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-http://host.docker.internal:11434/v1}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-ollama}
      CLOUD_FALLBACK_ENABLED: ${CLOUD_FALLBACK_ENABLED:-false}
      # Модель эмбеддингов уже в образе; в рантайме Hugging Face не вызываем
      TRANSFORMERS_OFFLINE: 1
      HF_HOME: /app/.cache/huggingface
      # Песочница: клоны репо и векторная память (по умолчанию /workspace)
      MEMORY_VECTOR_PERSIST_DIR: /workspace/assistant_vectors
      SANDBOX_WORKSPACE_DIR: /workspace
      # Путь для клонирования репо: по умолчанию /workspace; для отдельного тома задайте GIT_WORKSPACE_DIR=/git_repos
      GIT_WORKSPACE_DIR: ${GIT_WORKSPACE_DIR:-/workspace}
    volumes:
      - workspace_sandbox:/workspace
      # Отдельный том для репо: смонтирован в /git_repos; задайте GIT_WORKSPACE_DIR=/git_repos в .env для использования
      - git_repos:/git_repos
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - assistant
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 1G
    user: "1000:1000"

  telegram-adapter:
    build:
      context: .
      dockerfile: assistant/docker/Dockerfile.telegram
    environment:
      REDIS_URL: redis://redis:6379/0
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - assistant
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 128M
    user: "1000:1000"

volumes:
  redis_data:
  # Песочница (общий workspace по умолчанию)
  workspace_sandbox:
  # Том для клонирования репо: задайте GIT_WORKSPACE_DIR=/git_repos в .env, чтобы клоны шли сюда
  git_repos:

networks:
  assistant:
    driver: bridge
