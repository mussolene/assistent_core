services:
  redis:
    image: redis:7-alpine
    container_name: assistant-redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - assistant
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M

  dashboard:
    build:
      context: .
      dockerfile: assistant/docker/Dockerfile.dashboard
    ports:
      - "8080:8080"
    environment:
      REDIS_URL: redis://redis:6379/0
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - assistant
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 128M
    user: "1000:1000"

  assistant-core:
    build:
      context: .
      dockerfile: assistant/docker/Dockerfile.core
    environment:
      REDIS_URL: redis://redis:6379/0
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-http://host.docker.internal:11434/v1}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-ollama}
      CLOUD_FALLBACK_ENABLED: ${CLOUD_FALLBACK_ENABLED:-false}
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - assistant
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 1G
    user: "1000:1000"

  telegram-adapter:
    build:
      context: .
      dockerfile: assistant/docker/Dockerfile.telegram
    environment:
      REDIS_URL: redis://redis:6379/0
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - assistant
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 128M
    user: "1000:1000"

  vector-db:
    image: qdrant/qdrant:v1.7.4
    volumes:
      - qdrant_storage:/qdrant/storage
    networks:
      - assistant
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
    # Qdrant пишет в /qdrant/storage; без user образ работает от root и volume доступен

volumes:
  redis_data:
  qdrant_storage:

networks:
  assistant:
    driver: bridge
