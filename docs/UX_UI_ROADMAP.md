# UX/UI: дорожная карта улучшений интерфейсов

Документ описывает аудит текущих интерфейсов (Telegram-бот, дашборд), применяет современные практики проектирования и задаёт поэтапную дорожную карту с покрытием тестами.

---

## Выполнено (итерации)

- **Фаза 1:** Обработчик /help со списком команд и кнопкой «Открыть настройки»; унификация /settings и /channels (один текст); приветствие по /start для неразрешённого пользователя с кнопками [Справка] [Настройки]; единый тон pairing («Привязка выполнена»). Тесты: `test_channels.py` (get_help_message_text, get_welcome_message_text, get_settings_message_text, PAIRING_SUCCESS_TEXT).
- **Фаза 2:** Сообщение при rate limit с «Повторите через 1 мин»; при ошибке загрузки репо — inline-кнопка «Открыть настройки». Тест: RATE_LIMIT_MESSAGE.
- **Фаза 3:** Навбар из 5 пунктов: Каналы (Telegram + Email на одной странице), Модель, Интеграции (MCP скиллы + MCP агент), Данные (Qdrant URL + ссылки на Репо и Память), Система (мониторинг). Qdrant URL только в разделе Данные; на странице Репо — подсказка «настраивается в Данные». Подсказка в MCP (агент) про общий Chat ID из Каналы → Telegram. Маршруты: /data, /save-data, /integrations, /system; /monitor → редирект на /system. Тесты: test_dashboard.py (index channels, data_page, save_data, integrations_page, system_page, monitor redirect).
- **Фаза 4:** CSS вынесен в `static/css/layout.css`, подключение через `<link>` в layout; добавлены стили `.btn:disabled`. Индикатор загрузки при «Проверить бота» и «Проверить подключение»: кнопки с id `btn-test-bot` и `btn-test-model`, отключение на время fetch и включение в `finally`. Тесты: test_layout_includes_stylesheet, test_test_bot_button_has_id_for_loading.
- **Фаза 5:** Регрессия: pytest assistant/tests, покрытие ≥90%, ruff без замечаний. Приёмочный чек-лист — docs/ACCEPTANCE.md.
- **П.5 улучшение списков:** Репо: подпись «Страница N из K» при известном total (склонированные). Функция `format_repos_reply_text(label, page, total)`; тесты в test_channels.py.
- **4.3 аккордеон «Дополнительно»:** На странице Модель блок Fallback, облачный fallback, LM Studio native и API ключ вынесены в `<details class="card">` с заголовком «Дополнительно»; стили в layout.css (`.details-summary`). Тест: test_model_page_has_accordion.
- **ROADMAP 3.4 справка по ролям:** В /help блок «Для админов» с /restart; в BOT_COMMANDS у команды restart поле `admin_only: True`. Тест: test_get_help_message_text_has_admin_section.
- **ROADMAP §1 управление пользователями:** Страница «Пользователи» (/users) для владельца: список пользователей, форма добавления (логин, пароль, роль). POST /add-user (только owner). В навбаре ссылка «Пользователи» только при role=owner. Тесты: test_list_users, test_users_page_owner_200, test_users_page_viewer_403, test_add_user_owner_creates_and_redirects.
- **ROADMAP §1 смена пароля:** auth.update_password; страница /change-password (текущий + новый пароль), ссылка «Сменить пароль» в шапке; на /users форма «Сменить пароль пользователя» (owner). Тесты: test_update_password, test_change_password_page_*.
- **Улучшение списков (задачи):** Длина заголовка в inline-кнопках списка задач ограничена 25 символами (format_tasks_for_telegram) для компактного отображения на мобильном.

---

## 1. Принципы и практики (2025–2026)

### 1.1 Общие

- **Единый источник правды** — одна настройка в одном месте; нет дублирования между разделами.
- **Прогрессивное раскрытие** — показывать только нужное сейчас; сложное — по шагам или в раскрывающихся блоках.
- **Контекстные действия** — кнопки и команды рядом с объектом, к которому относятся.
- **Обратная связь** — каждое действие: немедленный отклик (loading), результат (успех/ошибка) и при необходимости подсказка.
- **Доступность** — контраст, размер мишеней (минимум ~44px), семантика для скринридеров, клавиатурная навигация.

### 1.2 Telegram и чат-боты

- **Онбординг** — при первом контакте: короткое приветствие, 1–2 главных действия, ссылка «Подробнее» (например, /help).
- **Команды и меню** — команды в меню бота должны иметь обработчики; справка (/help) всегда возвращает актуальный список и короткие пояснения.
- **Inline-кнопки** — для выбора из ограниченного набора (подтверждение, пагинация, выбор задачи); не перегружать сообщение (до ~8 кнопок в одном сообщении).
- **Короткие сообщения** — разбивать длинный текст на абзацы; списки — маркированные; важное — выделять (bold в HTML).
- **Единый тон** — дружелюбный, нейтральный «вы»; одинаковые формулировки для одинаковых сценариев (ошибки, успех).

### 1.3 Веб-дашборд (настройки)

- **Группировка по смыслу** — не «вкладки по технологиям» (Telegram, MCP, Email), а «Каналы», «Модель и API», «Интеграции», «Система» с подразделами внутри.
- **Без дублирования** — один параметр (например, Chat ID для уведомлений) задаётся в одном месте; при необходимости — ссылка «используется в …».
- **Формы** — логические блоки в карточках; опциональные поля свернуты или во вторичном блоке; одна кнопка «Сохранить» на блок/страницу где возможно.
- **Визуальная иерархия** — заголовок страницы → подзаголовок → карточки; акцент на первичном действии (сохранить, проверить).

---

## 2. Аудит текущего состояния

### 2.1 Telegram-бот

| Проблема | Описание |
|----------|----------|
| **/help не обработан** | Команда есть в меню бота, но отдельного ответа нет — пользователь может попасть в общий диалог или не получить ответ. |
| **/settings и /channels идентичны** | Дублирование: один и тот же текст и ссылка. Достаточно одной команды или развести по смыслу (настройки vs «где смотреть каналы»). |
| **Нет приветствия при /start** | После /start (без кода) при выключенном pairing пользователь не получает пояснения: что это за бот, что делать дальше, ссылку на /help. |
| **Нет быстрых действий после старта** | Нет inline-кнопок «Справка», «Настройки», «Задачи» — всё только через команды. |
| **Разные формулировки однотипных ответов** | «Привязка выполнена» / «Pairing выполнен» — лучше один стиль. «Передано агенту» для /dev — ок, но можно чуть расширить. |
| **Rate limit** | Сообщение «Rate limit exceeded. Try again later.» — без указания, когда можно повторить (через N секунд). |
| **Список репо** | Inline-кнопки и пагинация есть; можно улучшить подпись (например, «Страница 1 из N»). |
| **Задачи** | Кнопки task:view, task:done и т.д. работают; текст списка можно сделать чуть компактнее на мобильном. |

### 2.2 Дашборд

| Проблема | Описание |
|----------|----------|
| **Восемь пунктов в навбаре** | Telegram, Модель, MCP, Мониторинг, Репо, Email, Память, MCP (агент) — перегрузка; два пункта про MCP сбивают с толку. |
| **Повторение концепции «Chat ID»** | «Chat ID для MCP/агента» на странице Telegram и «Telegram Chat ID» на странице MCP (агент) для каждого endpoint — разный контекст, но можно явно связать подсказкой и не дублировать описание. |
| **Qdrant URL только в Репо** | Qdrant относится и к индексации репо, и к памяти разговоров — логично вынести в «Данные / Память» или общий блок «Векторная БД». |
| **Один длинный список форм** | На страницах (Email, Модель, Репо) много полей подряд; нет группировки в аккордеоны или вкладки внутри страницы. |
| **Нет явной группировки «Каналы»** | Telegram и Email — каналы; логично объединить в раздел «Каналы» с подразделами. |
| **Мониторинг отдельно** | Мониторинг — не «настройка», а состояние; можно оставить отдельным пунктом или вынести в «Система» вместе с памятью. |
| **Дизайн** | Тёмная тема есть; нет компонентной системы (разные отступы, размеры кнопок); нет индикации загрузки при «Проверить подключение» / «Проверить бота». |

### 2.3 Дублирование настроек (источник правды)

- **Chat ID**  
  - Telegram-страница: «Chat ID для MCP/агента (уведомления, confirm)» — глобальный fallback.  
  - MCP (агент): у каждого endpoint свой «Telegram Chat ID».  
  Итог: не дублирование, а два разных параметра; в подсказках стоит указать: «Если не задан — используется общий из раздела Telegram».

- **Qdrant**  
  Сейчас только на странице «Репо». Память разговоров (страница «Память») использует Qdrant; URL коллекции или подключения логично иметь в одном месте (например, «Данные» или «Память» с полем Qdrant URL).

---

## 3. Рекомендации по интерфейсу бота (Telegram)

1. **Обработчик /help**  
   Всегда возвращать сообщение со списком команд и кратким описанием (1 строка на команду). Формат: заголовок «Справка», затем список с моноширинным кодом команд и пояснением. При необходимости — inline-кнопка «Открыть настройки» (URL дашборда).

2. **Унификация /settings и /channels**  
   Оставить одну команду, например /settings (в меню и в справке), с текстом: «Настройки и дашборд: &lt;URL&gt;. Там можно задать токен бота, разрешённые ID, модель, MCP и др.» Команду /channels либо удалить, либо сделать алиасом (тот же ответ).

3. **Приветствие по /start**  
   Если пользователь не по коду и не в режиме pairing: отправить короткое приветствие (1–2 предложения), перечень главных команд (/help, /settings, задачи — «просто напишите, что нужно сделать») и при необходимости inline-кнопки: [Справка] [Настройки].

4. **Единый тон сообщений**  
   Выбрать один вариант для успешных действий («Готово», «Сохранено», «Привязка выполнена») и для ошибок; для rate limit добавить «Повторите через N мин» при возможности.

5. **Улучшение списков**  
   Репо: подпись «Страница 1 из K» (если известно). Задачи: без изменения логики можно чуть сократить длину заголовка в кнопках (уже есть ограничение по символам).

6. **Ошибки и краевые случаи**  
   При ошибке загрузки репо (GitHub/GitLab) давать короткую причину («Проверьте токен в дашборде») и кнопку «Открыть настройки» (URL).

---

## 4. Рекомендации по дашборду

### 4.1 Структура без «восьми вкладок»

Предлагаемая группировка (вместо восьми равноправных пунктов):

- **Главная / Обзор** (опционально) — статус каналов, модель, последние действия; быстрые ссылки.
- **Каналы** — внутри: **Telegram** (токен, pairing, разрешённые ID, Chat ID для MCP), **Email** (включить, SMTP/SendGrid, отправитель). Одна «вкладка» или одна длинная страница с секциями — без дублирования полей между разделами.
- **Модель** — URL, имя модели, fallback, LM Studio, API ключ, «Проверить подключение».
- **Интеграции** — **MCP-серверы** (список серверов для скиллов), **MCP (агент)** — endpoint’ы для Cursor (имя, Chat ID, URL, секрет). В подсказке у Chat ID: «Если не задан — используется общий Chat ID из раздела Каналы → Telegram».
- **Данные** (или **Память и репо**) — **Qdrant URL** (один раз: для индексации и для памяти), **Репозитории**: токены GitHub/GitLab, путь workspace, список склонированных; **Память разговоров**: очистка по user_id/chat_id. Так Qdrant не дублируется, настройки репо и памяти в одном смысловом блоке.
- **Система** — **Мониторинг** (Redis, ключи, подключения), при необходимости — аудит/здоровье.

Итог: навбар из 4–6 пунктов (например: Обзор, Каналы, Модель, Интеграции, Данные, Система), внутри — якорные ссылки или подстраницы без повторения одних и тех же полей.

### 4.2 Устранение дублирования

- **Qdrant URL** — только в разделе «Данные» (Память и репо); на странице «Репо» — подсказка «Qdrant настраивается в разделе Данные» или поле только для чтения с переходом. Либо оставить одно поле в «Данные», а в «Репо» использовать его без дублирования.
- **Chat ID для MCP** — глобальный только в Каналы → Telegram. В Интеграции → MCP (агент) у каждого endpoint свой Chat ID; в подсказке указать использование глобального, если не задан.

### 4.3 Визуал и UX

- Вынести CSS (и при необходимости общие куски верстки) в `static/` и шаблоны; ввести небольшую компонентную систему (карточка, кнопка, форма, подсказка).
- Добавить индикатор загрузки при нажатии «Проверить бота» / «Проверить подключение» (например, спиннер и отключение кнопки).
- Единые отступы и размеры кнопок; первичная кнопка — «Сохранить» или «Проверить»; вторичные — «Отмена», «Очистить».
- Опционально: раскрывающиеся блоки (аккордеоны) для редко меняемых или продвинутых настроек (например, LM Studio native, аргументы MCP).

---

## 5. Поэтапная дорожная карта (с тестами)

Каждый этап заканчивается: реализация → тесты → регрессия → коммит (без push).

---

### Фаза 1: Telegram — справка и приветствие

| Шаг | Задача | Критерии приёмки | Тесты |
|-----|--------|-------------------|-------|
| 1.1 | Добавить обработчик **/help** в Telegram-адаптере: ответ с списком команд и кратким описанием (из BOT_COMMANDS или отдельный текст). | При отправке /help пользователь получает одно сообщение со списком команд. | Юнит/интеграционный тест: мок getUpdates с text="/help", проверка вызова sendMessage с текстом, содержащим команды (start, help, settings, …). |
| 1.2 | Унифицировать **/settings** и **/channels**: один текст и ссылка; /channels — алиас (тот же ответ). | Обе команды возвращают одинаковый ответ. | Тест: два вызова (message text /settings и /channels), один и тот же ожидаемый текст/ссылка в sendMessage. |
| 1.3 | При **/start** (без кода, без глобального pairing) отправлять приветствие: что за бот, «напишите вопрос или /help», опционально inline-кнопки [Справка] [Настройки]. | Новый пользователь (не в whitelist или без pairing) получает приветствие и не уходит в «тишину». | Тест: getUpdates с /start, пользователь не в allowed, pairing выключен — проверка sendMessage с приветствием и (опционально) reply_markup. |

**Покрытие:** тесты в `assistant/tests/` — либо расширить существующие тесты Telegram (если есть), либо добавить `test_telegram_commands.py` с моками httpx/Redis.

---

### Фаза 2: Telegram — тон и ошибки

| Шаг | Задача | Критерии приёмки | Тесты |
|-----|--------|-------------------|-------|
| 2.1 | Привести к одному стилю сообщения: привязка («Привязка выполнена»), pairing («Привязка выполнена» или тот же текст), /dev («Передано агенту»). | Нет разночтений «Pairing выполнен» vs «Привязка выполнена». | Проверка в тестах фраз в sendMessage для сценариев pairing и /dev. |
| 2.2 | Rate limit: в ответе при превышении лимита добавить «Повторите через 1 мин» (или вычисленное время, если доступно). | Пользователь видит подсказку, когда можно повторить. | Тест: лимитер возвращает «запрет», проверка текста ответа бота. |
| 2.3 | Репо: при ошибке загрузки GitHub/GitLab — короткая причина и, по возможности, inline-кнопка «Настройки» (URL дашборда). | Ошибка репо не просто «проверьте дашборд», а с кнопкой. | Тест с моком ошибки API репо — проверка reply_markup с url. |

---

### Фаза 3: Дашборд — группировка и навигация

| Шаг | Задача | Критерии приёмки | Тесты |
|-----|--------|-------------------|-------|
| 3.1 | Переименовать и сгруппировать пункты навбара: например **Каналы** (объединить Telegram + Email в один раздел с подсекциями или якорями), **Модель**, **Интеграции** (MCP скиллы + MCP агент), **Данные** (Репо + Память + Qdrant), **Система** (Мониторинг). Без дублирования полей между разделами. | В навбаре 4–6 пунктов; при переходе в «Каналы» видны Telegram и Email; в «Данные» — Qdrant, репо, память. | E2E или тесты рендера: проверка наличия ссылок в nav (например, «Каналы», «Данные»); проверка, что форма Telegram доступна по /channels или /channels#telegram. |
| 3.2 | Вынести **Qdrant URL** в одно место (раздел «Данные» или «Память»); на странице репо использовать это значение или показывать подсказку «настраивается в Данные». | Qdrant URL редактируется только в одном месте. | Тест: сохранение Qdrant в «Данные», проверка, что на странице репо отображается тот же URL или подсказка. |
| 3.3 | В блоке MCP (агент) в подсказке к Chat ID указать: «Если не задан — используется общий Chat ID из Каналы → Telegram». | Подсказка видна в шаблоне. | Тест рендера или проверка текста в HTML ответа. |

**Покрытие:** расширить `test_dashboard.py` — проверка маршрутов, редиректов, наличия форм и ключевых подсказок в HTML.

---

### Фаза 4: Дашборд — визуал и UX

| Шаг | Задача | Критерии приёмки | Тесты |
|-----|--------|-------------------|-------|
| 4.1 | Вынести общий CSS в `static/css/` (или оставить один файл), подключить в layout; унифицировать отступы и размеры кнопок (переменные или классы). | Стили не дублируются в строках; кнопки выглядят единообразно. | Ручная проверка или тест наличия ссылки на stylesheet. |
| 4.2 | Добавить индикатор загрузки при «Проверить бота» и «Проверить подключение»: кнопка disabled, спиннер или текст «…», по ответу — результат. | Пользователь видит, что запрос выполняется. | Тест JS (если вынесен в отдельный файл) или приёмка: кнопка блокируется при fetch. |
| 4.3 | Опционально: аккордеоны для блоков «Дополнительно» (LM Studio, аргументы MCP) — меньше визуального шума. | Раскрытие по клику; состояние можно не сохранять. | Приёмка. |

---

### Фаза 5: Регрессия и приёмка

| Шаг | Задача | Критерии приёмки | Тесты |
|-----|--------|-------------------|-------|
| 5.1 | Полный прогон тестов: `pytest assistant/tests`; линт. | Все тесты зелёные; линт без новых замечаний. | CI или локальный pytest. |
| 5.2 | Приёмочный чек-лист: Telegram (/start, /help, /settings, /channels, репо, задачи); дашборд (все разделы, сохранение, проверка бота/модели). | Все пункты из docs/ACCEPTANCE.md проходят. | Ручная проверка по ACCEPTANCE.md. |

---

## 6. Зависимости и порядок

- **Фаза 1** может выполняться первой и не зависит от дашборда.
- **Фаза 2** зависит только от кода Telegram-адаптера.
- **Фаза 3** меняет маршруты и шаблоны дашборда; тесты — в основном дашборд и конфиг.
- **Фаза 4** опирается на новую навигацию (3) и не ломает бэкенд.
- **Фаза 5** — после 1–4.

Рекомендуемый порядок: **1 → 2 → 3 → 4 → 5**. При нехватке времени приоритет: 1 (help/start), 3 (группировка и один Qdrant), 5 (регрессия).

---

## 7. Где хранить код и тесты

- **Telegram:** логика команд и тексты — в `assistant/channels/telegram.py`; тексты справки и приветствия можно вынести в константы или маленький модуль `assistant/channels/telegram_texts.py` для удобства тестов.
- **Дашборд:** маршруты и группировка — `assistant/dashboard/app.py`; шаблоны — по возможности в `assistant/dashboard/templates/`, статика — `assistant/dashboard/static/`.
- **Тесты:**  
  - Telegram-команды: `assistant/tests/test_telegram_commands.py` (новый или расширить существующий тест адаптера).  
  - Дашборд: `assistant/tests/test_dashboard.py`, `assistant/tests/test_dashboard_auth.py` — добавить кейсы на новые маршруты и контент.

После каждой итерации (по правилам проекта): коммит с описанием этапа, без push.
