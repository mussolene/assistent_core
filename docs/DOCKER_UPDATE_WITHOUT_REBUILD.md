# Обновление кода без пересборки контейнеров

Способы получать изменения из репозитория (например GitHub) без `docker compose build`.

---

## 1. Volume + git pull на хосте (рекомендуется для разработки и self-hosted)

Код лежит на хосте в клонированном репозитории; контейнеры монтируют его как volume. Образ собирается один раз (или только при смене зависимостей). Обновление кода — `git pull` на хосте.

### Шаги

1. **Клонировать репозиторий на хост:**
   ```bash
   git clone https://github.com/YOUR_ORG/assistent_core.git
   cd assistent_core
   ```

2. **Собрать образы один раз** (или при изменении `Dockerfile` / `requirements.txt`):
   ```bash
   docker compose build
   ```

3. **Запускать с монтированием кода** — использовать override, чтобы подмонтировать текущую директорию поверх кода в образе:
   - Создайте `docker-compose.override.yml` (не коммитить, только локально) со см. примером ниже.

4. **Обновление кода из GitHub без пересборки:**
   ```bash
   git pull
   docker compose restart assistant-core telegram-adapter dashboard
   ```
   Или автоматизировать проверку каждые N минут через cron на хосте:
   ```bash
   # cron: каждые 5 минут проверить обновления и перезапустить сервисы при изменении
   */5 * * * * cd /path/to/assistent_core && git fetch && [ -n "$(git diff HEAD origin/main --name-only)" ] && git pull && docker compose restart assistant-core telegram-adapter dashboard
   ```

### Пример docker-compose.override.yml (только для такого сценария)

Файл подставляется поверх основного `docker-compose.yml`. В репозитории лежит пример:

```bash
cp docker-compose.override.example.yml docker-compose.override.yml
```

Он монтирует код с хоста в `/app`, чтобы контейнер использовал актуальные файлы после `git pull` + restart. Файл `docker-compose.override.yml` добавлен в `.gitignore` — не коммитить.

Важно: в основном образе пакет ставится как `pip install -e .` в `/app`. При монтировании `.:/app` поверх образа хостовая директория (с `pyproject.toml` и `assistant/`) становится `/app`, и процесс использует этот код. После `git pull` перезапуск контейнеров подхватывает изменения.

Ограничение: зависимости (pip) и модель эмбеддингов остаются из образа. Менять зависимости или модель по-прежнему нужно через пересборку образа.

### Отдельный том для клонирования репо

По умолчанию репозитории клонируются в общий workspace (`/workspace`). Чтобы хранить клоны в отдельном томе:

1. В `.env` задайте: `GIT_WORKSPACE_DIR=/git_repos`.
2. В дашборде в разделе «Репо» можно задать тот же путь (или оставить пустым — core возьмёт значение из env/Redis после перезапуска).

В `docker-compose.yml` том `git_repos` уже смонтирован в `/git_repos` для сервисов `assistant-core` и `dashboard`.

---

## 2. Entrypoint: git pull при старте контейнера

Образ не содержит кода приложения: при каждом запуске контейнер клонирует репозиторий (или делает `git pull`), ставит пакет и запускает приложение. Пересборка не нужна для обновления кода — достаточно перезапустить контейнер.

- Плюсы: не нужен volume с репо на хосте; подходит для облака, где нет доступа к хосту.
- Минусы: при старте нужна сеть и доступ к GitHub; первый запуск дольше; для «проверять каждые N минут» нужен отдельный механизм (перезапуск по расписанию или скрипт внутри контейнера).

Реализация требует отдельного Dockerfile/образа с entrypoint-скриптом (clone/pull, pip install, exec). Можно вынести в отдельный файл, например `assistant/docker/Dockerfile.core.live-pull`, и описать в этом документе.

---

## 3. Проверка каждые N минут без пересборки

- **На хосте:** cron (см. п. 1) — раз в 5–10 минут `git fetch`/`git pull` и при наличии изменений `docker compose restart ...`.
- **Внутри инфраструктуры:** отдельный сервис (контейнер), который раз в N минут клонирует/пуллит репо в общий volume и дергает API перезапуска или перезапускает контейнеры (через Docker API или вызов `docker compose restart` на хосте). Это сложнее и зависит от окружения.

---

## Итог

| Цель                         | Способ                                      |
|-----------------------------|---------------------------------------------|
| Разработка / self-hosted   | Volume (override) + `git pull` + restart    |
| Авто-проверка каждые N мин  | Cron на хосте: `git pull` + restart         |
| Обновление без хостового репо | Образ с entrypoint «git pull при старте» + перезапуск контейнера |

Для типичного сценария «не пересобирать, подтягивать с GitHub» достаточно варианта 1 и cron при необходимости проверки каждые несколько минут.
