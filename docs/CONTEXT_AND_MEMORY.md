# Модель контекста и памяти

Документ описывает, **что где хранится** и **как контекст подмешивается в промпт** при запросе к модели. Контекст не привязан к конкретной модели: одна и та же структура сообщений передаётся любому провайдеру (LM Studio, Ollama, OpenAI и т.д.).

---

## 1. Где что хранится

| Хранилище | Ключи / путь | Содержимое |
|-----------|--------------|------------|
| **Redis** | short_term по user_id/session_id | Последние N сообщений диалога (user/assistant). Окно задаётся `memory.short_term_window` (по умолчанию 10). |
| **Redis** | summary по user_id/session_id | Сжатое резюме более старых сообщений. Обновляется при превышении порога сообщений (`memory.summary_threshold_messages`). |
| **Redis** | task_memory по task_id | Результаты вызовов инструментов в рамках текущей задачи (для формирования query при векторном поиске). |
| **Redis** | user_data по user_id | Произвольные данные о пользователе (имя, предпочтения и т.п.), заполняются скиллом или вручную. |
| **Redis** | assistant:tasks:user:*, assistant:task:* | Задачи пользователя (tasks skill). В контекст промпта не подмешиваются автоматически; модель запрашивает их через скилл list_tasks. |
| **Локальные файлы** | vector_persist_dir / user_id / short|medium|long.json | Векторная память трёх уровней (эмбеддинги + тексты). Используется только при установленном `sentence-transformers` (extra `vector`). |
| **Qdrant** | коллекция conversation_memory | Долговременная память разговоров (эмбеддинги сообщений, индексация при диалоге). Опционально; требует Qdrant URL и эмбеддинги. |
| **Qdrant** | коллекции документов/репо | Проиндексированные документы и репозитории. Доступ через скиллы vector_rag, search_repos, index_document, index_repo. |

Итог: **ядро без векторной памяти** — только Redis (short_term, summary, user_data, задачи). С опцией `vector` добавляются локальные векторные хранилища; при настроенном Qdrant — conversation memory и RAG по документам.

---

## 2. Как собирается контекст для промпта

Метод `MemoryManager.get_context_for_user()` формирует список сообщений в порядке:

1. **Summary** (если есть) — одно сообщение `role: system` с текстом «Previous context summary: …».
2. **User data** (если есть) — одно сообщение `role: system` с полями пользователя.
3. **Short-term** — последние сообщения диалога (user/assistant) в хронологическом порядке.
4. **Vector hits** (если `include_vector=True` и доступна модель эмбеддингов) — релевантные фрагменты из трёх уровней векторной памяти (short, medium, long); объединяются в одно системное сообщение «Relevant memory: …».
5. **Qdrant conversation memory** (если настроен Qdrant и коллекция) — релевантные фрагменты из памяти разговоров; системное сообщение «Relevant conversation memory: …».

В агенте (assistant) к этому списку добавляются: текущая дата (system), затем все сообщения из контекста (кроме system — они уже учтены в промпте через другие части), затем текущее сообщение пользователя и tool results. Итог уходит в модель как единый запрос.

**Задачи (tasks)** в контекст не подставляются автоматически: модель получает их через вызов скилла `list_tasks` и использует по необходимости. Это уменьшает размер промпта и даёт актуальный список.

---

## 3. Независимость от модели

- Выбор провайдера (LM Studio, OpenAI, Ollama и т.д.) и имя модели задаются в дашборде или env. Память и контекст к ним не привязаны.
- Один и тот же `get_context_for_user()` вызывается независимо от того, какая модель будет использована. Формат сообщений — общий (роли, текст).
- Смена модели не требует миграции памяти: все хранилища (Redis, файлы, Qdrant) остаются теми же.

---

## 4. Опциональность эмбеддингов

- **Без** установки extra `vector` (sentence-transformers): векторная память не инициализируется (или возвращает пустые результаты). В контекст попадают только short_term, summary, user_data; векторные блоки и Qdrant conversation memory не добавляются (или пропускаются при ошибке загрузки модели).
- **С** `pip install .[vector]`: доступны локальные векторные хранилища и, при настроенном Qdrant, память разговоров и RAG по документам.
- Минимальный рабочий контур: Redis + short_term + summary + задачи (через скилл) + модель. Эмбеддинги и Qdrant — опциональное расширение.

Подробнее об установке и ядре: [CORE_PRODUCT.md](CORE_PRODUCT.md).
