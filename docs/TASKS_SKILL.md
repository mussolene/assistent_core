# Скилл «Задачи» (tasks)

Управление персональными задачами: создание, удаление, обновление, датирование, документы и ссылки, напоминания. **Хранение в разрезе пользователя:** задачи доступны только владельцу (по `user_id`).

---

## Хранение

- **Redis:** ключи `assistant:tasks:user:{user_id}` — список id задач; `assistant:task:{task_id}` — JSON задачи (внутри есть `user_id` для проверки доступа). TTL 2 года.
- **Напоминания:** sorted set `assistant:reminders:due` (score = Unix timestamp, member = task_id). При срабатывании напоминания запись из set удаляется.

---

## Действия скилла (action)

| action | Параметры | Описание |
|--------|-----------|----------|
| `create_task` | title, description?, start_date?, end_date?, priority?, status?, parent_id?, document_ids?, conversation_id?, text?/phrase? | Создать задачу. text/phrase — полуформализация (парсер). parent_id — подзадача. document_ids, conversation_id — связи с документом/разговором. |
| `delete_task` | task_id | Удалить задачу (только свою). |
| `update_task` | task_id, title?, start_date?, end_date?, priority?, status?, workload?, time_spent?, time_spent_minutes?, document_ids?, conversation_id?, cascade?=true | Обновить задачу. При смене дат — cascade. |
| `list_tasks` | status? | Список своих задач. Возвращает также **formatted** — готовый текст с заголовками, датами (дд.мм), оценкой загрузки и затраченным временем. |
| `get_task` | task_id | Одна задача (только своя). |
| `add_document` | task_id, document (url, name) | Добавить документ к задаче. |
| `add_link` | task_id, link (url, name) | Добавить ссылку. |
| `set_reminder` | task_id, reminder_at (ISO datetime) | Установить напоминание. |
| `get_due_reminders` | — | Список сработавших напоминаний (для воркера/агента). |
| `search_tasks` | query (или q) | Поиск по подстроке в title/description. Для формулировок «задачу о X». |
| `format_for_telegram` | max_items?, task_ids?, button_action? | Текст и inline_keyboard. button_action: view \| delete \| update \| add_document \| add_link; task_ids — только эти задачи для кнопок выбора. |
| `archive_completed` | — | Перенести все задачи со статусом done в архив (исключить из основного списка). Возвращает archived_count и user_reply. |
| `list_archive` | from_date?, to_date? | Список заархивированных задач. Фильтр по периоду — по дате updated_at (YYYY-MM-DD). |
| `search_archive` | query? (или q), from_date?, to_date? | Поиск по архиву: подстрока в title/description и опционально фильтр по датам (updated_at). |
| `list_subtasks` | parent_id (или task_id) | Список подзадач родительской задачи. |

**user_id** подставляется автоматически из контекста (ToolAgent передаёт `context.user_id` для скилла `tasks`).

---

## Полуформализация фразы (create_task с text/phrase)

При вызове **create_task** без `title` можно передать **text** или **phrase** — короткую фразу. Скилл вызывает парсер `parse_task_phrase` и подставляет **title**, **end_date**, **description** по шаблонам:

| Шаблон | Пример | Результат |
|--------|--------|------------|
| «сегодня X» | сегодня позвонить маме | end_date=сегодня, title=позвонить маме |
| «завтра X» | завтра купить молоко | end_date=завтра, title=купить молоко |
| «послезавтра X» | послезавтра отчёт | end_date=послезавтра, title=отчёт |
| «через N дней X» | через 3 дня сдать проект | end_date=через 3 дня, title=сдать проект |
| «X к ДД.ММ» | отчёт к 15.03 | end_date=15.03, title=отчёт |
| «X на понедельник» | звонок на понедельник | end_date=след. понедельник, title=звонок |
| «высокий/низкий/средний приоритет X» | высокий приоритет срочный баг | priority=high, title=срочный баг |

Если шаблон не сработал, вся фраза попадает в **title**. Парсер используется и при создании задачи из диалога (агент передаёт phrase/text), и при вызове MCP create_task с параметром text или phrase.

---

## Модель задачи

- `id`, `user_id`, `title`, `description`, `parent_id` (опционально — id родительской задачи для подзадач)
- `start_date`, `end_date` (ISO YYYY-MM-DD)
- `priority` — опционально: `high`, `medium`, `low` (из парсера фразы «высокий приоритет X» или через create_task/update_task)
- `workload`, `estimate` — оценка загрузки (строка, например «2ч», «полдня»)
- `time_spent_minutes` — затраченное время в минутах (можно задать через update_task с time_spent: «2h», «30 min»)
- `documents`, `links`, `reminder_at`, `status`, `created_at`, `updated_at`
- `document_ids` — опционально: список идентификаторов документов (связь с индексированными документами / векторной памятью)
- `conversation_id` — опционально: идентификатор разговора, с которым связана задача (связь документ — задача — разговор)

---

## Список задач и ответ пользователю

- На запрос «список задач» вызывается **list_tasks(only_actual=true)**; ответ — **formatted** и **inline_keyboard** (кнопка «✓ Выполнена»).
- В списке по умолчанию: **заголовок** и **дата создания** (создана дд.мм); опционально — срок, оценка, затрачено.
- **Порядковые номера:** «вторая задача», «поставь третью как выполненную», «покажи что во второй» — это номер в списке (1-based). Ассистент вызывает list_tasks, берёт tasks[номер−1].id и выполняет update_task или get_task. Детали одной задачи: **get_task** возвращает **formatted_details** (описание, даты, документы, ссылки).

## Список задач в Telegram и выбор при нескольких

- **format_for_telegram** возвращает `text` и `inline_keyboard` с датами в формате дд.мм и опционально workload. Параметр **button_action**: `view` | `delete` | `update` | `add_document` | `add_link` — в `callback_data` уходит `task:{action}:{task_id}`.
- **task_ids** — опционально список id; если передан, форматируются только эти задачи (удобно после `search_tasks` для кнопок «с какой задачей выполнить действие»).
- Агент отправляет сообщение с `reply_markup: { inline_keyboard }`. При нажатии кнопки Telegram-адаптер обрабатывает `task:view:*`, `task:delete:*` и т.д. и публикует в шину **IncomingMessage** с текстом-инструкцией («Покажи детали задачи с id …», «Удали задачу с id …» и т.д.), после чего ассистент выполняет действие.

---

## Работа на естественном языке

- Пользователь может писать в Telegram, например: «Создай задачку по работе с репозиторием», «Удали задачку по работе с репозиторием», «Поправь задачу о репозиториях и добавь то-то», «Добавь документ к задаче про репозитории».
- Ассистент сначала вызывает **search_tasks(query)** по ключевым словам из формулировки. Если найдена одна задача — выполняет действие; если несколько — отвечает «Нашлось несколько задач. Выберите:» и вызывает **format_for_telegram** с найденными `task_ids` и нужным **action**, чтобы показать кнопки выбора. После нажатия кнопки приходит сообщение с указанием task_id — ассистент выполняет удаление/правку/добавление документа или ссылки.

### Даты и дедлайны обычным языком

- Даты передавать только если пользователь явно назвал срок («на понедельник», «до 25 февраля»). Если дата не указана — не придумывать; при указании даты без года используется текущий год. В контекст модели подставляется текущая дата (YYYY-MM-DD).
- При создании задачи скилл отбрасывает start_date/end_date с годом меньше текущего (защита от ошибочно подставленного прошлого года).

### Затраченное время и оценка загрузки

- «Потратил 2 часа на задачу X», «добавь к задаче про репо 30 минут» — через **update_task** с **time_spent** (строка «2h», «30 min» или число минут). Скилл хранит **time_spent_minutes**.
- Оценка загрузки: **workload** или **estimate** (например «2ч», «полдня») в create_task / update_task.

### Каскадный перенос при смене дат

- При **update_task** с новыми start_date/end_date остальные задачи пользователя, чей интервал пересекается с новым, сдвигаются на тот же дельта (в днях). Отключить: **cascade=false**.

---

## Напоминания и будильники

- **set_reminder(task_id, reminder_at)** — обязательны оба параметра; `reminder_at` в формате ISO datetime. Рекомендуется UTC с суффиксом `Z` или `+00:00`; если таймзона не указана (например `2025-02-22T12:35:00`), скилл трактует время как UTC и сохраняет с `+00:00`. Для «напомни про неё через 5 минут» ассистент определяет задачу, вычисляет reminder_at = сейчас + 5 минут в UTC и вызывает set_reminder.
- **set_reminder** записывает в задачу `reminder_at` и добавляет task_id в sorted set с score = timestamp.
- **get_due_reminders_sync(redis_url)** — синхронная функция: возвращает список задач, у которых напоминание уже должно было сработать, и удаляет их из set. Вызывается воркером или по крону.
- Рекомендуемый сценарий: отдельный процесс/скрипт раз в минуту вызывает `get_due_reminders_sync`, для каждой записи отправляет уведомление в Telegram (chat_id = user_id или через MCP notify) с текстом «Напоминание: задача …» и при необходимости подсказкой по решению.
- **Воркер напоминаний:** скрипт `reminders-worker` (или `python -m assistant.reminders_worker`) читает `REDIS_URL`, вызывает `get_due_reminders_sync`, публикует по каждому напоминанию `OutgoingReply` в шину (канал Telegram). Запуск по крону, например каждую минуту: `* * * * * REDIS_URL=redis://... reminders-worker`.

---

## Архив (итерация 10.6)

- **Хранение:** список id заархивированных задач в `assistant:tasks:archive:user:{user_id}`. Тела задач остаются в `assistant:task:{id}`.
- **archive_completed:** все задачи пользователя со статусом `done` удаляются из основного списка (`assistant:tasks:user:{user_id}`) и добавляются в архив. В основном списке остаются только открытые и не заархивированные.
- **list_archive:** возвращает задачи из архива с опциональным фильтром `from_date`, `to_date` (по полю updated_at задачи).
- **search_archive (10.7):** поиск по архиву — параметры `query` (или `q`), `from_date`, `to_date`. Фильтрация по подстроке в title/description и по периоду updated_at. Возвращает tasks и formatted с датами.

---

## Помощь в решении

- В системном промпте ассистента указано: помогать с решением задач (предлагать шаги, напоминать о дедлайнах).
- Агент может вызывать `list_tasks` / `get_task` и на основе описания и дат предлагать план или напоминать о сроках.

---

## Реализованные расширения (10.5–10.8)

- **Список в Telegram (10.5):** только актуальные задачи (open, end_date ≥ сегодня); кнопка «✓ Выполнена» (callback `task:done:{id}`); при нажатии — статус задачи обновляется и сообщение со списком редактируется.
- **Компактный список** неактуальных; **архивация (10.6):** archive_completed, list_archive; **поиск по архиву (10.7):** search_archive(query, from_date, to_date).
- **Подзадачи (10.8):** поле `parent_id` в задаче; create_task(parent_id=…); list_subtasks(parent_id); get_task возвращает subtasks и блок «Подзадачи» в formatted_details.

См. **docs/TASKS_REQUIREMENTS.md** и блок 10 в **docs/ITERATIONS_ROADMAP.md**.

---

## Тесты

- `assistant/tests/test_tasks_skill.py`: создание, список, изоляция по user_id, удаление, обновление, документы/ссылки, запрет доступа к чужой задаче, `format_tasks_for_telegram`, `get_due_reminders_sync` (мок Redis).
