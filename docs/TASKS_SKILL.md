# Скилл «Задачи» (tasks)

Управление персональными задачами: создание, удаление, обновление, датирование, документы и ссылки, напоминания. **Хранение в разрезе пользователя:** задачи доступны только владельцу (по `user_id`).

---

## Хранение

- **Redis:** ключи `assistant:tasks:user:{user_id}` — список id задач; `assistant:task:{task_id}` — JSON задачи (внутри есть `user_id` для проверки доступа). TTL 2 года.
- **Напоминания:** sorted set `assistant:reminders:due` (score = Unix timestamp, member = task_id). При срабатывании напоминания запись из set удаляется.

---

## Действия скилла (action)

| action | Параметры | Описание |
|--------|-----------|----------|
| `create_task` | title, description?, start_date?, end_date?, status?, workload?, time_spent? | Создать задачу. |
| `delete_task` | task_id | Удалить задачу (только свою). |
| `update_task` | task_id, title?, start_date?, end_date?, status?, workload?, time_spent?, time_spent_minutes?, cascade?=true | Обновить задачу. При смене дат остальные задачи, попадающие в новый интервал, сдвигаются (cascade). |
| `list_tasks` | status? | Список своих задач. Возвращает также **formatted** — готовый текст с заголовками, датами (дд.мм), оценкой загрузки и затраченным временем. |
| `get_task` | task_id | Одна задача (только своя). |
| `add_document` | task_id, document (url, name) | Добавить документ к задаче. |
| `add_link` | task_id, link (url, name) | Добавить ссылку. |
| `set_reminder` | task_id, reminder_at (ISO datetime) | Установить напоминание. |
| `get_due_reminders` | — | Список сработавших напоминаний (для воркера/агента). |
| `search_tasks` | query (или q) | Поиск по подстроке в title/description. Для формулировок «задачу о X». |
| `format_for_telegram` | max_items?, task_ids?, button_action? | Текст и inline_keyboard. button_action: view \| delete \| update \| add_document \| add_link; task_ids — только эти задачи для кнопок выбора. |

**user_id** подставляется автоматически из контекста (ToolAgent передаёт `context.user_id` для скилла `tasks`).

---

## Модель задачи

- `id`, `user_id`, `title`, `description`
- `start_date`, `end_date` (ISO YYYY-MM-DD)
- `workload`, `estimate` — оценка загрузки (строка, например «2ч», «полдня»)
- `time_spent_minutes` — затраченное время в минутах (можно задать через update_task с time_spent: «2h», «30 min»)
- `documents`, `links`, `reminder_at`, `status`, `created_at`, `updated_at`

---

## Список задач и ответ пользователю

- На запрос «список задач» ассистент вызывает **list_tasks**; в ответ пользователю подставляется поле **formatted** (без сырого JSON). Имена действий — с подчёркиванием: `list_tasks`, не `listtasks`.
- В списке отображаются даты в формате дд.мм, оценка загрузки (workload) и затраченное время (time_spent_minutes).

## Список задач в Telegram и выбор при нескольких

- **format_for_telegram** возвращает `text` и `inline_keyboard` с датами в формате дд.мм и опционально workload. Параметр **button_action**: `view` | `delete` | `update` | `add_document` | `add_link` — в `callback_data` уходит `task:{action}:{task_id}`.
- **task_ids** — опционально список id; если передан, форматируются только эти задачи (удобно после `search_tasks` для кнопок «с какой задачей выполнить действие»).
- Агент отправляет сообщение с `reply_markup: { inline_keyboard }`. При нажатии кнопки Telegram-адаптер обрабатывает `task:view:*`, `task:delete:*` и т.д. и публикует в шину **IncomingMessage** с текстом-инструкцией («Покажи детали задачи с id …», «Удали задачу с id …» и т.д.), после чего ассистент выполняет действие.

---

## Работа на естественном языке

- Пользователь может писать в Telegram, например: «Создай задачку по работе с репозиторием», «Удали задачку по работе с репозиторием», «Поправь задачу о репозиториях и добавь то-то», «Добавь документ к задаче про репозитории».
- Ассистент сначала вызывает **search_tasks(query)** по ключевым словам из формулировки. Если найдена одна задача — выполняет действие; если несколько — отвечает «Нашлось несколько задач. Выберите:» и вызывает **format_for_telegram** с найденными `task_ids` и нужным **action**, чтобы показать кнопки выбора. После нажатия кнопки приходит сообщение с указанием task_id — ассистент выполняет удаление/правку/добавление документа или ссылки.

### Даты и дедлайны обычным языком

- Даты передавать только если пользователь явно назвал срок («на понедельник», «до 25 февраля»). Если дата не указана — не придумывать; при указании даты без года используется текущий год. В контекст модели подставляется текущая дата (YYYY-MM-DD).
- При создании задачи скилл отбрасывает start_date/end_date с годом меньше текущего (защита от ошибочно подставленного прошлого года).

### Затраченное время и оценка загрузки

- «Потратил 2 часа на задачу X», «добавь к задаче про репо 30 минут» — через **update_task** с **time_spent** (строка «2h», «30 min» или число минут). Скилл хранит **time_spent_minutes**.
- Оценка загрузки: **workload** или **estimate** (например «2ч», «полдня») в create_task / update_task.

### Каскадный перенос при смене дат

- При **update_task** с новыми start_date/end_date остальные задачи пользователя, чей интервал пересекается с новым, сдвигаются на тот же дельта (в днях). Отключить: **cascade=false**.

---

## Напоминания и будильники

- **set_reminder** записывает в задачу `reminder_at` и добавляет task_id в sorted set с score = timestamp.
- **get_due_reminders_sync(redis_url)** — синхронная функция: возвращает список задач, у которых напоминание уже должно было сработать, и удаляет их из set. Вызывается воркером или по крону.
- Рекомендуемый сценарий: отдельный процесс/скрипт раз в минуту вызывает `get_due_reminders_sync`, для каждой записи отправляет уведомление в Telegram (chat_id = user_id или через MCP notify) с текстом «Напоминание: задача …» и при необходимости подсказкой по решению.

---

## Помощь в решении

- В системном промпте ассистента указано: помогать с решением задач (предлагать шаги, напоминать о дедлайнах).
- Агент может вызывать `list_tasks` / `get_task` и на основе описания и дат предлагать план или напоминать о сроках.

---

## Тесты

- `assistant/tests/test_tasks_skill.py`: создание, список, изоляция по user_id, удаление, обновление, документы/ссылки, запрет доступа к чужой задаче, `format_tasks_for_telegram`, `get_due_reminders_sync` (мок Redis).
