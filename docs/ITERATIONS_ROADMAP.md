# Дорожная карта итераций

Разбивка развития продукта на мелкие итерации. После каждой итерации: **Аналитика → Разработка → Тестирование → Исправление → Приёмка → Аудит**. Регрессия по всему проекту перед коммитом. Коммит без push, описание = что сделано в итерации.

---

## Блок 1: Поиск репозиториев в GitHub и GitLab

| Итерация | Статус | Содержание | Критерии приёмки |
|----------|--------|------------|-------------------|
| **1.1** | [x] | Поиск репозиториев в GitHub: API skill/helper (GITHUB_TOKEN, query) → список репо (name, url, description). | Есть функция/скилл `search_github_repos(query)`; тесты с моками. |
| **1.2** | [x] | Поиск репозиториев в GitLab: API (GITLAB_TOKEN, query) → список проектов. | Есть `search_gitlab_repos(query)`; тесты с моками. |
| **1.3** | [x] | Единое действие скилла git: `search_repos` (platform=github\|gitlab\|both, query). Регистрация в системном промпте. | Агент может запрашивать поиск репо; тесты; регрессия git-скилла. |

---

## Блок 2: Настройки авторизации на фронтенде

| Итерация | Статус | Содержание | Критерии приёмки |
|----------|--------|------------|-------------------|
| **2.1** | [x] | Аудит текущей авторизации дашборда: login, session, SECRET_KEY, защита маршрутов. Документ + доп. тесты. | Документ `docs/DASHBOARD_AUTH.md`; тесты на auth (уже есть test_dashboard_auth); список рекомендаций. |
| **2.2** | [x] | Проверка и доработка: отображение состояния (кто залогинен, logout), опционально endpoint `/api/session` для фронта. | Фронт/дашборд показывает логин/логаут; тесты; регрессия дашборда. |

---

## Блок 3: Индексация документов из бота в Qdrant

| Итерация | Статус | Содержание | Критерии приёмки |
|----------|--------|------------|-------------------|
| **3.1** | [x] | Приём документов в Telegram: фото/документ → сохранение в песочницу или временное хранилище, извлечение текста (или метаданные + blob). | Telegram-адаптер передаёт в событии тип и путь/контент документа; тесты. |
| **3.2** | [x] | Паipeline: документ → чанки + embedding → upsert в Qdrant. Использование существующего vector_rag или расширение. Конфиг Qdrant URL (env/dashboard). | Есть сервис/скилл индексации документа в Qdrant; тесты с моком Qdrant/embedding. |
| **3.3** | [x] | Действие для ассистента: «проиндексировать вложенный документ» (связка входящего документа с пайплайном). | Ассистент может принять документ и проиндексировать; приёмка; регрессия. |

---

## Блок 4: Email-канал и отправка на почту

| Итерация | Статус | Содержание | Критерии приёмки |
|----------|--------|------------|-------------------|
| **4.1** | [x] | Настройка Email в дашборде: SMTP или API-ключ (SendGrid и т.п.), from_address. Хранение в Redis/env. | Секция Email в дашборде; сохранение/чтение настроек; тесты. |
| **4.2** | [x] | Исходящий email-адаптер: при событии OutgoingReply с channel=EMAIL — отправка письма (SMTP/API). | Адаптер подписан на шину, шлёт письма; тесты с моком SMTP/API. |
| **4.3** | [x] | Скилл `send_email`: to, subject, body, опционально вложение. Rate limit и allowlist получателей. | Агент может отправить письмо через скилл; тесты; регрессия. |

---

## Блок 5: Настройка каналов и авторизации через бота

| Итерация | Статус | Содержание | Критерии приёмки |
|----------|--------|------------|-------------------|
| **5.1** | [x] | Команды бота: `/settings` или `/channels` — выдать ссылку на дашборд и краткую справку по настройкам. | Обработка команд в Telegram-адаптере; тесты. |
| **5.2** | [x] | Опционально: привязка пользователя к дашборду через бота (код в боте → ввод в дашборде). Документация сценария. | Документ или реализация; приёмка. |

---

## Блок 6: Список склонированных репозиториев

| Итерация | Статус | Содержание | Критерии приёмки |
|----------|--------|------------|-------------------|
| **6.1** | [x] | Скилл git: действие `list_cloned` / `list_repos` — сканирование workspace на директории с `.git`, возврат списка (path, remote URL). | Вызов `git.run({"action": "list_repos"})` возвращает список; тесты. |
| **6.2** | [x] | Опционально: страница дашборда или API «Склонированные репо» (если бэкенд имеет доступ к workspace). | Документ или реализация; регрессия. |

---

## Блок 7: Репозитории в Qdrant (чанки, RAG)

| Итерация | Статус | Содержание | Критерии приёмки |
|----------|--------|------------|-------------------|
| **7.1** | [x] | Действие «индексировать репо»: по пути repo_dir — обход файлов, чанки (по файлу/размеру), embedding, upsert в Qdrant с метаданными (repo, path, rev). | Скилл или пайплайн `index_repo(repo_dir)`; тесты с моками. |
| **7.2** | [x] | RAG-запросы: использование коллекций «репо» и при необходимости «память разговоров»; конфигурируемые коллекции. | Документ и/или код; регрессия vector_rag. |

---

## Блок 8: Embeddings и память разговоров

| Итерация | Статус | Содержание | Критерии приёмки |
|----------|--------|------------|-------------------|
| **8.1** | [x] | Параллельная индексация: при сообщении (или фоново) — embedding последних сообщений и upsert в Qdrant (коллекция «conversation memory»). | Пайплайн или хук; тесты. |
| **8.2** | [x] | Контекст ассистента: выборка из «conversation memory» по user_id/chat_id и подмешивание в промпт. | Ассистент использует память разговоров в запросах; тесты. |
| **8.3** | [x] | Очистка памяти: скилл или API `clear_memory` (user_id, chat_id опционально); кнопка в дашборде «Очистить мою память разговоров». | Действие и UI/API; тесты; регрессия. |

---

## Блок 9: UX канала Telegram и дашборд

| Итерация | Статус | Содержание | Критерии приёмки |
|----------|--------|------------|-------------------|
| **9.1** | [x] | **Markdown в Telegram:** сообщения приходят со «сырыми» знаками разметки. У Telegram свой формат (Markdown/MarkdownV2/HTML). Адаптировать исходящие сообщения: конвертация/экранирование под выбранный parse_mode, чтобы в чате отображалась корректная разметка (жирный, код, списки). | Все исходящие сообщения в Telegram отображаются без лишних символов; тесты. |
| **9.2** | [x] | **Команды бота: репозитории.** В Telegram: авторизация на GitHub/GitLab (OAuth/токен через дашборд или бот), получение и просмотр списка репозиториев с градацией (сначала избранные, затем по папкам/проектам), поиск репо по имени. Вывод списка как набор команд/кнопок в чате (на которые можно нажать), кнопки «назад»/«вперёд» для постраничной навигации. | Команды типа /repos, /github, /gitlab; список репо с inline-кнопками; пагинация; тесты. |
| **9.3** | [x] | **Favicon дашборда:** сгенерировать иконку сайта, разместить в статике дашборда, подключить в разметке всех страниц. Сейчас вкладка показывает пустой лист. | В корне дашборда отдаётся favicon; иконка отображается во вкладке браузера. |

**Примечание:** при запросе на продолжение (например, от агента/MCP) использовать канал Telegram для подтверждения (MCP ask_confirmation / send_confirmation_request уже публикуют в шину; кнопки обрабатываются в Telegram-адаптере).

---

## Блок 10: Задачи (Tasks) — персональный скилл

| Итерация | Статус | Содержание | Критерии приёмки |
|----------|--------|------------|-------------------|
| **10.1** | [x] | Скилл tasks: модель задачи (title, description, start/end date, documents, links, reminder_at, status). Хранение в Redis по user_id; CRUD, add_document, add_link, set_reminder. Изоляция: только свои задачи. | Документ `docs/TASKS_SKILL.md`; тесты в `test_tasks_skill.py`; регистрация в main + промпт ассистента. |
| **10.2** | [x] | format_for_telegram: текст списка задач + inline_keyboard с callback_data `task:view:{id}`. get_due_reminders_sync для воркера напоминаний. | Агент может вывести список задач в чат с кнопками; тесты; напоминания обрабатываются воркером. |
| **10.3** | [x] | Обработка callback в Telegram: при нажатии `task:view:{id}` — ответ с деталями задачи (или ссылка на дашборд). | В Telegram-адаптере обрабатывается callback; тесты. |
| **10.4** | [x] | Воркер напоминаний: процесс/скрипт по крону вызывает get_due_reminders_sync и шлёт уведомления в Telegram (chat_id по user_id). | Напоминания доставляются пользователю; документ или конфиг. |
| **10.5** | [x] | Список задач в формате Telegram API: только актуальные (open, end_date ≥ сегодня); кнопка «✓ Выполнена» (callback task:done:id); сообщение со списком можно удалять/заменять при новом вызове. | list_tasks(only_actual), format_for_telegram с кнопкой done; callback task:done в адаптере. |
| **10.6** | [x] | Компактный список неактуальных задач; архивация: «заархивировать выполненные» → перенос done в архив. list_archive, фильтр по периоду. | archive_completed, list_archive, хранение архива. |
| **10.7** | [x] | Поиск по архиву по смыслу (title/description) с фильтром по датам; результат с датами. | search_archive(query, from_date, to_date). |
| **10.8** | [x] | Подзадачи: parent_id в задаче, create_task(parent_id), list_subtasks(parent_id), отображение в деталях/списке. | Модель и скилл; тесты. |

Требования детально: **docs/TASKS_REQUIREMENTS.md**.

---

## Блок 11: Фаза 1 (2026) — ядро и полуформализация задач

| Итерация | Статус | Содержание | Критерии приёмки |
|----------|--------|------------|-------------------|
| **11.1** | [x] | Единая схема задачи: title, end_date (due), priority, description (notes). Парсер фразы уже поддерживает шаблоны (завтра X, X к ДД.ММ, высокий приоритет X). Добавить поле **priority** в модель задачи (high/medium/low), парсер возвращает priority, create_task/update_task сохраняют, format_task_details отображает. | В задаче есть priority; фраза «высокий приоритет X» создаёт задачу с priority=high; тесты; TASKS_SKILL.md обновлён. |

Документ «Ядро продукта»: **docs/CORE_PRODUCT.md** (уже есть). Дальнейшие итерации Фазы 1 (опционально LLM для разбора произвольной фразы) — по необходимости.

---

## Блок 12: Фаза 2 (2026) — интеграции To-Do и Calendar

| Итерация | Статус | Содержание | Критерии приёмки |
|----------|--------|------------|-------------------|
| **12.1** | [x] | Microsoft To-Do: OAuth, REST API (создание задачи, список списков). Скилл integrations (create_task_in_todo и др.), модуль assistant/integrations/todo.py. | To-Do API и скилл; тесты; документ INTEGRATIONS_TODO_CALENDAR.md. |
| **12.2** | [x] | Дашборд: секция/страница «Интеграции» для привязки To-Do (OAuth). Заглушка Google Calendar (assistant/integrations/calendar.py). | Секция в дашборде; хранение токенов; заглушка Calendar. |

Полная интеграция Google Calendar (OAuth, события) — в следующих итерациях при необходимости.

---

## Блок 13: Фаза 3 (2026) — MCP как исполнитель сценариев

| Итерация | Статус | Содержание | Критерии приёмки |
|----------|--------|------------|-------------------|
| **13.1** | [x] | MCP-инструменты: add_calendar_event, sync_task_to_todo (вызов IntegrationsSkill). create_task и list_tasks уже были. | tools/list возвращает все 7 инструментов; tools/call для sync_task_to_todo и add_calendar_event; тесты. |
| **13.2** | [x] | Документация MCP: список инструментов и сценарии (уведомления, задачи, To-Do, календарь) в MCP_DEV_SERVER.md. | Раздел «Сценарии использования» и таблица инструментов обновлены. |

Стабильность (ошибки, таймауты, логирование вызовов) — уже частично в app (try/except, logger.info по tools/call); при необходимости вынести в отдельную итерацию.

---

## Блок 14: Фаза 4 (2026) — память и контекст, независимые от модели

| Итерация | Статус | Содержание | Критерии приёмки |
|----------|--------|------------|-------------------|
| **14.1** | [x] | Документ «Модель контекста»: что хранится где (short_term, summary, vector, user_data, задачи, Qdrant), в каком порядке контекст подмешивается в промпт, независимость от выбора модели, опциональность эмбеддингов. | docs/CONTEXT_AND_MEMORY.md; ссылка из CORE_PRODUCT.md. |

---

## Блок 15: Google Calendar (полная интеграция)

| Итерация | Статус | Содержание | Критерии приёмки |
|----------|--------|------------|-------------------|
| **15.1** | [x] | Google Calendar: OAuth2 (get_oauth_url, exchange_code_for_tokens, refresh), хранение токенов в Redis. Calendar API v3: создание события (add_calendar_event — primary calendar, title, start_iso, end_iso, description). | calendar_is_configured(), add_calendar_event() при настроенных GOOGLE_CALENDAR_*; тесты. |
| **15.2** | [x] | Дашборд: блок Google Calendar на странице Интеграции, кнопка «Подключить Calendar (OAuth)», callback /integrations/calendar/callback. | Статус «Подключено» при наличии токенов; INTEGRATIONS_TODO_CALENDAR.md обновлён. |

---

## Блок 16: Связи документ — задача — разговор, UX, Фаза 5 (голос)

| Итерация | Статус | Содержание | Критерии приёмки |
|----------|--------|------------|-------------------|
| **16.1** | [x] | В модели задачи: опциональные поля **document_ids** (список id документов), **conversation_id** (id разговора). create_task/update_task принимают и сохраняют; format_task_details отображает; TASKS_SKILL.md обновлён. | Задача может быть связана с документом и разговором; тест test_tasks_create_with_document_ids_and_conversation_id. |
| **16.2** | [x] | UX (UX_UI_ROADMAP): длина заголовка в inline-кнопках списка задач — 25 символов; запись в «Выполнено». | format_tasks_for_telegram использует title[:25] для кнопок. |
| **16.3** | [x] | Фаза 5 (фундамент): приём **голосовых сообщений** в Telegram-адаптере. message.voice → вложение (file_id, mime_type, duration), скачивание в telegram_uploads; при отсутствии текста — подпись «[Голосовое сообщение: N сек]». STT не реализован — только точка входа. | IncomingMessage с attachments и текстом-заглушкой; тест _fallback_text_for_attachments. |

---

## Прочие доработки (вне нумерации блоков)

| Когда | Что сделано | Коммит / примечание |
|-------|-------------|----------------------|
| 2026-02 | **Дефолт модели — LM Studio** (порт 1234, ключ lm-studio). Подсказки и сообщения об ошибке без привязки к Ollama. | README, .env.example, gateway, dashboard, docker-compose. |
| 2026-02 | **Метрики хоста на странице мониторинга**: CPU %, память (используется/всего/%), load average, диск /. Секция «Хост (машина сборки)» в /system, API /api/monitor возвращает host. | psutil в зависимостях дашборда. |

---

## Процесс после каждой итерации

1. **Аналитика** — что именно делаем, границы, зависимости, риски.
2. **Разработка** — код, конфиг, миграции при необходимости.
3. **Тестирование** — юнит/интеграционные тесты по новой функциональности.
4. **Исправление** — правки по результатам тестов и ревью.
5. **Приёмочное тестирование** — проверка критериев приёмки.
6. **Регрессия** — прогон всех тестов проекта (`pytest assistant/tests`), линт, при необходимости ручные проверки.
7. **Аудит** — краткий обзор изменений, выявление неточностей и рисков; исправление.
8. **Коммит** — `git add` + `git commit` с описанием итерации, **без push**.

---

## Порядок выполнения (рекомендуемый)

- Блоки 1, 2, 6 можно вести раньше (минимальные зависимости).
- Блок 3 зависит от Qdrant и пайплайна embedding (можно после 8.1 или параллельно с 7).
- Блок 4 (email) и 5 (бот-настройки) независимы друг от друга.
- Блок 7 и 8 связаны с Qdrant и RAG — имеет смысл 8.1 перед 7.2 (память разговоров как база), затем 7.1 (индекс репо), затем 7.2.

**Сделано:** 1.1–10.8, **11.1**, **12.1–12.2**, **13.1–13.2**, **14.1**, **15.1–15.2**, **16.1–16.3** (связи документ–задача–разговор, UX кнопки задач, приём voice в Telegram); прочие доработки: дефолт LM Studio (1234), метрики хоста на /system. Покрытие тестами 90% (ROADMAP §0).  
**Дальше (2026):** [docs/ANALYTICS_AND_ROADMAP_2026.md](ANALYTICS_AND_ROADMAP_2026.md). Опционально: STT для голоса, новые блоки.

Детальная дорожная карта по UX/UI (Telegram-бот, дашборд, группировка настроек, тесты): **[docs/UX_UI_ROADMAP.md](UX_UI_ROADMAP.md)**.
