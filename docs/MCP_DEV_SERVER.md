# MCP-сервер для агента (разработка)

Проект можно использовать как **MCP-сервер** для Cursor (или другого клиента): агент может уведомлять вас в Telegram, запрашивать подтверждение и получать обратную связь.

## Настройка

1. **Telegram**: токен бота и хотя бы один разрешённый User ID (как обычно).
2. **Chat для MCP**: в дашборде (Telegram) укажите **Chat ID для MCP/агента** или задайте `TELEGRAM_DEV_CHAT_ID` в `.env`. Для личного чата Chat ID = User ID. Если не задано — используется первый из разрешённых.
3. Запустите `assistant-core` и `telegram-adapter`, чтобы бот получал сообщения и отправлял ответы.

## Подключение в Cursor

В настройках MCP добавьте сервер (stdio):

```json
{
  "mcpServers": {
    "assistant-dev": {
      "command": "python",
      "args": ["-m", "assistant.mcp_server"]
    }
  }
}
```

Либо через `assistant-mcp-server`, если установлен пакет:

```json
{
  "command": "assistant-mcp-server"
}
```

Рабочая директория — корень проекта (или где установлен `assistant-core`), чтобы подхватывались `REDIS_URL` и конфиг из Redis.

## Инструменты

| Инструмент | Описание |
|------------|----------|
| **notify** (message) | Отправить сообщение в основной канал (Telegram). Для уведомлений о ходе работы, вопросах, необходимости действия. |
| **ask_confirmation** (message, timeout_sec?) | Отправить запрос в Telegram и ждать ответа. Пользователь пишет `confirm` / `reject` или произвольный текст. По умолчанию таймаут 300 с. Возвращает `{confirmed, rejected, reply}`. |
| **get_user_feedback** () | Забрать накопленные сообщения от пользователя (команда `/dev текст` в Telegram). Возвращает список строк; после вызова очередь очищается. |

## Поведение в Telegram

- **Ответ на запрос подтверждения**: когда агент вызвал `ask_confirmation`, следующее сообщение в этом чате считается ответом: `confirm`/`ok`/`yes`/`да` → подтверждение, `reject`/`no`/`cancel`/`нет`/`отмена` → отмена, иначе — произвольный ответ в поле `reply`. Сообщение не уходит в диалог с ассистентом.
- **/dev текст** — добавляет текст в очередь обратной связи; агент забирает его через `get_user_feedback`. Ответ бота: «Передано агенту.»

## Пример сценария

1. Агент в Cursor вызывает `notify("Начинаю рефакторинг модуля X.")`.
2. Перед `git push` вызывает `ask_confirmation("Выполнить push в origin/main?", 60)` — вы в Telegram пишете `confirm` или `reject`.
3. Периодически вызывает `get_user_feedback()` — получает то, что вы отправили через `/dev пожелание по коду`.

## Ограничения

- Один «основной» чат на конфиг (один пользователь для MCP).
- Подтверждение — одно ожидание на чат; повторный вызов `ask_confirmation` до ответа перезаписывает ожидание.
- Обратная связь хранится в Redis (список по chat_id), при перезапуске не теряется (TTL 7 дней).
